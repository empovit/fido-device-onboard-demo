- name: Generate keys and certificates
  hosts: certificate_generator
  become: true
  gather_facts: false
  vars:
    generated_certs_dir: /etc/fdo/keys
  roles:
    - community.fdo.generate_keys_and_certificates
  tasks:
    - name: Fetch generated keys and certificates
      ansible.posix.synchronize:
        src: /etc/fdo/keys/
        dest: "{{ playbook_dir }}/keys/"
        mode: pull
        checksum: true
        rsync_timeout: 60

- name: Set up manufacturing_server
  hosts: manufacturing_server
  become: true
  gather_facts: true
  vars:
    manufacturing_server_generate_keys_and_certificates: false
    rendezvous_server: "{{ groups['rendezvous_server'][0] }}"
    manufacturing_server_rendezvous_info_ip_address: "{{ hostvars[rendezvous_server].ansible_host | default(hostvars[rendezvous_server].inventory_hostname) }}"
    localhost_manufacturing_server_certs_dir: "{{ playbook_dir }}/keys"
  roles:
    - community.fdo.setup_manufacturing_server
    - community.fdo.copy_manufacturing_server_certs_to_manufacturing_server
    - community.fdo.configure_manufacturing_server

- name: Set up rendezvous server
  hosts: rendezvous_server
  become: true
  gather_facts: true
  vars:
    copy_manufacturer_certs: false
    update_cert: false
    localhost_manufacturing_server_certs_dir: "{{ playbook_dir }}/keys"
  roles:
    - community.fdo.setup_rendezvous_server
    - community.fdo.copy_manufacturing_server_certs_to_rendezvous_server
    - community.fdo.configure_rendezvous_server

- name: Set up owner server
  hosts: owner_server
  become: true
  gather_facts: true
  vars:
    copy_manufacturer_certs: false
    update_keys_certs: false
    localhost_manufacturing_server_certs_dir: "{{ playbook_dir }}/keys"
    owner_onboarding_server_owner_addresses_ip_address: "{{ hostvars[inventory_hostname].ansible_host | default(inventory_hostname) }}"
    serviceinfo_api_server_config: |-
      initial_user:
        username: admin
        sshkeys:
        - "{{ lookup('file', '/home/vit/.ssh/id_ed25519.pub') }}"
      commands:
      - command: touch
        args:
        - /fdo-inboard-success
        return_stdout: true
        return_stderr: true
      diskencryption_clevis:
      - disk_label: /dev/vda4
        binding:
          pin: tpm2
          config: "{}"
        reencrypt: true
      additional_serviceinfo: ~
  roles:
    - community.fdo.setup_owner_server
    - community.fdo.copy_manufacturing_server_certs_to_owner_server
    - community.fdo.configure_owner_server
